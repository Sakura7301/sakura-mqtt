# <center>SAKURA-MQTT-SDK网络层开发指南</center>

## <center>v1.0.0</center>



**联系邮箱: sakuraduck@foxmail.com**




## 免责声明

Sakura7301拥有随时修改本手册的权利，内容如有更改，恕不另行通知。包括但不限于对产品特定用途适用性和适销性的隐含保证。

Sakura7301对本手册中包含的错误或对本手册的使用所带来的偶然或继起损害不承担任何责任。


| 版本   | 修改日期   | 描述     |
| :----- | :--------- | :------- |
| v1.0.0 | 2023-06-21 | 初版发布 |





## 一、接口用法概述

该套网络接口为同步接口，函数返回值标识函数调用结果，错误的返回值会导致SDK出错；接口既可以实现为阻塞的，也可以实现为非阻塞；接口均由SDK调用，开发者只需按照要求实现函数，无需调用。

## 二、详细接口描述

### 1. 创建网络套接字接口

用于创建网络套接字，SDK用该函数的返回值标识每个网络连接。

#### 1.1 接口定义

``` c
sakura_int32_t sakura_sock_create(sakura_void_t);
```

#### 1.2 参数说明

无

#### 1.3 返回值说明

|  返回值类型  | 说明                                    |
| :----------: | :-------------------------------------- |
| sakura_int32_t | >=0： 网络套接字的句柄<br>-1： 创建失败 |

****

### 2. 网络套接字连接接口

用于和服务器建立网络连接，该函数是同步接口，返回值标识连接是否成功，sock为sakura_sock_create函数返回值，serv中保存服务器域名/ip和端口号，开发者需要使用传入的域名/ip以及端口发起连接。

#### 2.1 接口定义

``` c
sakura_int32_t sakura_sock_connect(sakura_int32_t sock, sakura_sock_host_t *serv);
```

#### 2.2 参数说明

| 参数名 | 必填 |     参数类型      | 说明               |
| :----: | :--: | :---------------: | :----------------- |
|  sock  |  是  |   sakura_int32_t    | 网络套接字句柄     |
|  serv  |  是  | sakura_sock_host_t* | 服务器域名和端口号 |

| 参数名       | 必填 | 参数类型           | 说明     |
| :----------- | :--- | :----------------- | :------- |
| hostname     | 是   | const sakura_char_t* | 域名/IP  |
| port         | 是   | sakura_uint16_t      | 端口     |

#### 2.3 返回值说明

|  返回值类型  | 说明                                  |
| :----------: | :------------------------------------ |
| sakura_int32_t | 0： 建立连接成功<br>-1： 建立连接失败 |

****

### 3. 数据发送接口

用于向服务器发送数据，该接口是同步接口，既可以实现为阻塞的，也可以实现为非阻塞的，返回值为非负数时表示发送成功的字节数，返回值为-1时表示发送失败。

#### 3.1 接口定义

``` c
sakura_int32_t sakura_sock_send(sakura_int32_t sock, const sakura_uint8_t *send_buf, sakura_uint32_t len);
```

#### 3.2 参数说明

|  参数名  | 必填 |      参数类型       | 说明             |
| :------: | :--: | :-----------------: | :--------------- |
|   sock   |  是  |    sakura_int32_t     | 网络套接字句柄   |
| send_buf |  是  | const sakura_uint8_t* | 待发送的数据     |
|   len    |  是  |    sakura_uint32_t    | 待发送的数据长度 |

#### 3.3 返回值说明

|  返回值类型  | 说明                                              |
| :----------: | :------------------------------------------------ |
| sakura_int32_t | &gt;=0： 发送成功的字节数<br>   -1： 数据发送失败 |

****

### 4. 数据接收接口

用于从服务器接收数据，该接口是同步接口，`必须`在接收数据时使用**`非阻塞`**的socket。返回值大于0表示本次接收到的字节数，返回值等于0表示连接被对端关闭，返回值为-2表示函数调用出错；当实现为非阻塞模式时，还应在同步模式基础上增加一种返回值-1，表示本次未接收到数据，需要重试。

对于Linux的非阻塞socket，使用如下代码实现非阻塞socket：

```
int flags = 0;
int flag = 1;
flags = fcntl(sock, F_GETFL, 0);
fcntl(sock, F_SETFL, flags | flag); 
```

对于Windows，参考如下代码实现非阻塞socket：

```
u_long mode=1;
ioctlsocket(sock, FIONBIO, &mode)
```


#### 4.1 接口定义

``` c
sakura_int32_t sakura_sock_recv(sakura_int32_t sock, sakura_uint8_t *recv_buf, sakura_uint32_t len);
```

#### 4.2 参数说明

|  参数名  | 必填 |      参数类型       | 说明             |
| :------: | :--: | :-----------------: | :--------------- |
|   sock   |  是  |    sakura_int32_t     | 网络套接字句柄   |
| recv_buf |  是  | const sakura_uint8_t* | 接收数据的缓冲区 |
|   len    |  是  |    sakura_uint32_t    | 缓冲区长度       |

#### 4.3 返回值说明

|  返回值类型  | 说明                                                         |
| :----------: | :----------------------------------------------------------- |
| sakura_int32_t | &gt;0：成功接收的字节数<br> =0：连接被对端关闭<br>  -1：本次未接收到数据，需要重试<br>  -2：函数调用出错 |

****

### 5. 关闭网络套接字接口

用于关闭网络套接字。

#### 5.1 接口定义

``` c
sakura_int32_t sakura_sock_close(sakura_int32_t sock);
```

#### 5.2 参数说明

| 参数名 | 必填 |   参数类型   | 说明           |
| :----: | :--: | :----------: | :------------- |
|  sock  |  是  | sakura_int32_t | 网络套接字句柄 |

#### 5.3 返回值说明

|  返回值类型  | 说明                                              |
| :----------: | :------------------------------------------------ |
| sakura_int32_t | 0： 网络套接字关闭成功<br>-1： 网络套接字关闭失败 |